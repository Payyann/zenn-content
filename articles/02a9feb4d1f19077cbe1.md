---
title: "Digdagã®ECS/Docker Command Executorã‚’åˆ©ç”¨ã—ã¦ã¿ãŸ"
emoji: "ğŸ“"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Digdag", "AWS", "ECS", "Docker"]
published: false
--- 

!!!!!!!!!!!!!!!!!!!!!!!!
DooDã§ã®container to container ã®runã‚³ãƒãƒ³ãƒ‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã‹ãˆã‚Œãªã„ã®ã§æ²¡
localã‹ã‚‰ã ã£ãŸã‚‰è‰¯ã„ã‹ã‚‚
!!!!!!!!!!!!!!!!!!!!!!!!


ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ³ã‚¸ãƒ³DigdagãŒECS/Dcokerã§ã®å®Ÿè¡Œç’°å¢ƒã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãŸã®ã§ä»Šå›ã¯Dockerã§åˆ©ç”¨ã—ã¦ã¿ã¾ã—ãŸã€‚
https://docs.digdag.io/command_executor.html

# å®Ÿè¡Œç’°å¢ƒ
OS: macOS

# å‰æº–å‚™
æœ€ä½é™ã‚µãƒ¼ãƒãŒå‹•ãç’°å¢ƒã‚’ç”¨æ„ã—ã¾ã—ãŸã€‚
https://github.com/Payyann/digdag_ecs

## ECRã®è¨­å®š
> If there is no valid configuration for ECS, fallback to Docker. If there is no valid configuration for Docker, fallback to local.

ã¨ã„ã†ã“ã¨ã‚‰ã—ã„ã®ã§ã€ä»Šå›ã¯ä»¥ä¸‹ã‚’å®Ÿç¾ã§ãã‚‹ã‹æ¤œè¨¼ã—ã¾ã™ã€‚
- ECSã¨Dockerã®åˆ‡æ›¿ã‚’configãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã®ã¿ã«ä¾å­˜ã•ã›ã‚‹ 
- digãƒ•ã‚¡ã‚¤ãƒ«ã¯å…±é€šåŒ–ã•ã›ã‚‹

ãã®ãŸã‚ã€å®Ÿéš›ã«ã¯å®Ÿè¡Œã—ãªã„ã§ã™ãŒECSã®ãƒ€ãƒŸãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’configãƒ•ã‚¡ã‚¤ãƒ«ã«è¨­å®šã—ã¾ã—ãŸã€‚
```properties: server.properties
~~

# ä»¥ä¸‹ã€ä¸æ­£ãªECRã®è¨­å®š
agent.command_executor.ecs.name = digdag-test

agent.command_executor.ecs.digdag-test.access_key_id = <ACCESS KEY>
agent.command_executor.ecs.digdag-test.secret_access_key = <SECRET KEY>
agent.command_executor.ecs.digdag-test.launch_type = FARGATE
agent.command_executor.ecs.digdag-test.region = us-east-1
agent.command_executor.ecs.digdag-test.subnets = subnet-NNNNN
agent.command_executor.ecs.digdag-test.max_retries = 3

agent.command_executor.ecs.temporal_storage.type = s3
agent.command_executor.ecs.temporal_storage.s3.bucket = <Bucket>
agent.command_executor.ecs.temporal_storage.s3.endpoint = s3.amazonaws.com
agent.command_executor.ecs.temporal_storage.s3.credentials.access-key-id = <ACCESS KEY>
agent.command_executor.ecs.temporal_storage.s3.credentials.secret-access-key = <SECRET KEY>
```

## DooD
å…¬å¼ã¨ã¯ç•°ãªã‚ŠDockerãƒ›ã‚¹ãƒˆã®Digdagã‚µãƒ¼ãƒã‚’åˆ©ç”¨ã™ã‚‹ã®ã§DooD(Docker outside of Docker)ã®æ§‹æˆãŒåˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚
```yaml:docker-compose.yml
version: '3'
services:
  digdag:
    build: .
    ports:
      - "65432:65432"
    volumes:
      - .:/digdag
      - /var/run/docker.sock:/var/run/docker.sock
    command: bash -c "digdag server -c server.properties -P params.yml"
    depends_on:
      - db
~~
```

ã“ã®è¨­å®šã§ã‚µãƒ¼ãƒã‚’èµ·å‹•ã—ã¾ã™ã€‚
```bash
$ docker-compose up
```


```digdag:mydag/mydag.dig
timezone: UTC

_export:
  ecs:
    task_definition_arn: "arn:aws:ecs:us-east-1:..."

+setup:
  echo>: start ${session_time}

+disp_current_date:
  echo>: ${moment(session_time).utc().format('YYYY-MM-DD HH:mm:ss Z')}

+repeat:
  for_each>:
    order: [first, second, third]
    animal: [dog, cat]
  _do:
    echo>: ${order} ${animal}
  _parallel: true

+teardown:
  echo>: finish ${session_time}
```
